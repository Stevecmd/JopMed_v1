{% extends "base.html" %}

{% block title %}Shopping Cart - JopMed{% endblock %}

{% block content %}
<div class="cart-container">
    <h1>Your Shopping Cart</h1>
    <div id="cart-items">
        <!-- Cart items will be dynamically inserted here -->
    </div>
    <div id="cart-total">Total: $<span id="total-amount">0.00</span></div>
    <button id="checkout-button">Proceed to Checkout</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cartItemsContainer = document.getElementById('cart-items');
        const totalAmountElement = document.getElementById('total-amount');

        function loadCart() {
            fetch('/cart', {
                headers: {
                    'User-ID': sessionStorage.getItem('user_id')
                },
                credentials: 'include'
            })
            .then(response => {
                if (response.status === 401) {
                    // User is not logged in
                    cartItemsContainer.innerHTML = '<p>Please <a href="/login">log in</a> to view your cart.</p>';
                    totalAmountElement.textContent = '0.00';
                    return Promise.reject('User not logged in');
                }
                return response.json();
            })
            .then(cart => {
                console.log('Cart data:', cart);
                if (!Array.isArray(cart)) {
                    console.error('Invalid cart data:', cart);
                    cartItemsContainer.innerHTML = '<p>Error loading cart. Please try again later.</p>';
                    return;
                }
                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = '<p>Your cart is empty.</p>';
                    totalAmountElement.textContent = '0.00';
                    return;
                }
                cartItemsContainer.innerHTML = '';
                let total = 0;
                cart.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'cart-item';
                    const itemData = item.product || item.service;
                    itemElement.innerHTML = `
                        <img src="${itemData.image_url || '/static/images/default-product.jpg'}" alt="${itemData.name}" class="cart-item-image">
                        <div class="cart-item-details">
                            <h3>${itemData.name}</h3>
                            <p>Price: $${itemData.price.toFixed(2)}</p>
                            <p>Quantity: ${item.quantity}</p>
                        </div>
                        <button class="remove-item" data-item-id="${item.id}">Remove</button>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                    total += itemData.price * item.quantity;
                });
                totalAmountElement.textContent = total.toFixed(2);
            })
            .catch(error => {
                if (error !== 'User not logged in') {
                    console.error('Error loading cart:', error);
                    cartItemsContainer.innerHTML = '<p>Error loading cart. Please try again later.</p>';
                }
            });
        }

        loadCart();

        cartItemsContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-item')) {
                const itemId = event.target.getAttribute('data-item-id');
                removeFromCart(itemId);
            }
        });

        function removeFromCart(itemId) {
            fetch('/cart/remove', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: productId
                }),
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadCart();
                } else {
                    alert('Failed to remove item from cart.');
                }
            })
            .catch(error => console.error('Error removing item from cart:', error));
        }

        document.getElementById('checkout-button').addEventListener('click', function() {
            window.location.href = '/checkout';
        });

        function updateQuantity(itemId, change) {
            fetch('/cart/update_cart_item', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: productId,
                    quantity: change
                }),
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    loadCart();  // Reload the entire cart to reflect changes
                } else {
                    alert(data.error || 'Failed to update cart.');
                }
            })
            .catch(error => {
                console.error('Error updating cart:', error);
                alert('Failed to update cart. Please try again.');
            });
        }
    });
</script>
{% endblock %}